- 1ã€[æŠ½å¥–æ´»åŠ¨](../demo/Promise/æŠ½å¥–æ´»åŠ¨Promiseç‰ˆ.html)
- 2ã€[AJAXè¯·æ±‚](../demo/Promise/AJAXè¯·æ±‚Promiseç‰ˆæœ¬.html)
- 3ã€[è¯»å–æ–‡ä»¶ä¿¡æ¯](../demo/Promise/è¯»å–æ–‡ä»¶Promise.js)
- 4ã€[ä½¿ç”¨Promiseå°è£…fsè¯»å–æ–‡ä»¶æ“ä½œ](../demo/Promise/ä½¿ç”¨Promiseå°è£…fsè¯»å–æ–‡ä»¶æ“ä½œ.js)
- 5ã€[ä½¿ç”¨Promiseå°è£…ä¸€ä¸ªå‘é€GETè¯·æ±‚çš„å‡½æ•°](../demo/Promise/ä½¿ç”¨Promiseå°è£…ä¸€ä¸ªå‘é€GETè¯·æ±‚çš„å‡½æ•°.html)

### ES6æ¨¡å—åŒ–
ES6 æ¨¡å—åŒ–è§„èŒƒä¸­å®šä¹‰:
- æ¯ä¸ª js æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—
- å¯¼å…¥å…¶å®ƒæ¨¡å—æˆå‘˜ä½¿ç”¨ `import` å…³é”®å­— 
- å‘å¤–å…±äº«æ¨¡å—æˆå‘˜ä½¿ç”¨ `export` å…³é”®å­—

### Promise
#### å‡½æ•°å¯¹è±¡ä¸å®ä¾‹å¯¹è±¡
**å‡½æ•°å¯¹è±¡**ï¼šå°†å‡½æ•°ä½œä¸ºå¯¹è±¡ä½¿ç”¨æ—¶ï¼Œç®€ç§°ä¸º**å‡½æ•°å¯¹è±¡**  
**å®ä¾‹å¯¹è±¡**ï¼šnew å‡½æ•°äº§ç”Ÿçš„å¯¹è±¡ï¼Œç®€ç§°ä¸º**å¯¹è±¡**  
  
```js
function Fn(){            // Fnå‡½æ•°

}
const fn = Fn()           // Fnæ˜¯æ„é€ å‡½æ•°ï¼Œfnæ˜¯å®ä¾‹å¯¹è±¡ï¼Œç®€ç§°ä¸ºå¯¹è±¡
console.log(Fn.prototype) // Fnæ˜¯å‡½æ•°å¯¹è±¡
Fn.call({})               // Fnæ˜¯å‡½æ•°å¯¹è±¡

$('#test')                // jQueryå‡½æ•°
$.get('/test')            // jQueryå‡½æ•°å¯¹è±¡
```
#### åŒæ­¥å›è°ƒå‡½æ•°å’Œå¼‚æ­¥å›è°ƒå‡½æ•°
**åŒæ­¥å›è°ƒ**ï¼šç«‹å³æ‰§è¡Œï¼Œå®Œå…¨æ‰§è¡Œå®Œäº†æ‰ç»“æŸï¼Œä¸ä¼šæ”¾å…¥å›è°ƒé˜Ÿåˆ—ä¸­  
  
**å¼‚æ­¥å›è°ƒ**ï¼šä¸ä¼šç«‹å³æ‰§è¡Œï¼Œä¼šæ”¾å…¥å›è°ƒé˜Ÿåˆ—ä¸­å°†æ¥æ‰§è¡Œï¼Œä¾‹å¦‚ï¼šå®šæ—¶å™¨å›è°ƒã€AJAXå›è°ƒã€PromiseæˆåŠŸã€å¤±è´¥çš„å›è°ƒã€fsæ–‡ä»¶æ“ä½œ  
```js
// åŒæ­¥å›è°ƒå‡½æ•°
const arr = [1, 3, 5]
arr.forEach(item => {     // éå†å›è°ƒ
  console.log(item)
})
console.log('forEach()ä¹‹å')
/* ä¾æ¬¡æ‰§è¡Œã€‚ä¸ä¼šè¢«æ”¾å…¥å›è°ƒé˜Ÿåˆ—ä¸­ */
```
```js
// å¼‚æ­¥å›è°ƒå‡½æ•°
setTimeout(() => {        // å¼‚æ­¥å›è°ƒå‡½æ•°ï¼Œä¼šè¢«æ”¾å…¥é˜Ÿåˆ—ä¸­å°†æ¥æ‰§è¡Œ
  console.log('timeout callback()')
}, 0)

console.log('setTimeout() ä¹‹å')
/* å…ˆæ‰§è¡Œå¤–é¢çš„console.logï¼Œå®šæ—¶å™¨çš„å‡½æ•°ä¼šè¢«æ”¾å…¥å›è°ƒé˜Ÿåˆ—ä¸­ï¼Œç­‰æ‰§è¡Œå®Œä¹‹åæ‰æ‰§è¡Œå›è°ƒé˜Ÿåˆ—ä¸­çš„å‡½æ•° */
```
#### é”™è¯¯
##### é”™è¯¯ç±»å‹
- 1ã€`Error`ï¼šæ‰€æœ‰é”™è¯¯çš„çˆ¶ç±»å‹
- 2ã€`ReferenceError`ï¼šå¼•ç”¨çš„å˜é‡ä¸å­˜åœ¨
- 3ã€`TypeError`ï¼šæ•°æ®ç±»å‹ä¸æ­£ç¡®çš„é”™è¯¯
- 4ã€`RangeError`ï¼šæ•°æ®å€¼ä¸åœ¨å…¶æ‰€å…è®¸çš„èŒƒå›´å†…
- 5ã€`SyntaxError`ï¼šè¯­æ³•é”™è¯¯

```js
console.log(a);         // ReferenceError: a is not defined

let b;
console.log(b.xxx)      // TypeError: Cannot read property 'xxx' of undefined

function fn() {
  fn()
}
fn()                    // RangeError: Maximum call stack size exceeded

const x = """"          // SyntaxError: Unexpected string
```
> å¦‚æœå‘ç”Ÿé”™è¯¯æ²¡æœ‰æ•è·é”™è¯¯ï¼Œåˆ™ä¼šåœæ­¢è§£é‡Šä¸‹é¢çš„ä»£ç 

##### é”™è¯¯å¤„ç†
- 1ã€æ•è·å¤„ç†ï¼š`try...catch`
- 2ã€æŠ›å‡ºé”™è¯¯ï¼š`throw error`

æ•è·é”™è¯¯ï¼š
```js
// æ•è·é”™è¯¯ï¼štry...catch
try {
  let d
  console.log(d.xxx)
} catch (error) {
  console.log(error.message)  // Cannot read property 'xxx' of undefined
  console.log(error.stack)    // TypeError: Cannot read property 'xxx' of undefined at <anonymous>:3:17
}
console.log('å‡ºé”™ä¹‹å')
/* æ•è·é”™è¯¯ä¹‹åï¼Œåé¢çš„ä»£ç å¯ä»¥æ‰§è¡Œ */
```
æŠ›å‡ºé”™è¯¯å¹¶æ•è·ï¼š
```js
// æŠ›å‡ºé”™è¯¯ï¼š throw error
function sometimes() {
  if (Date.now() % 2 == 1){
      console.log('å½“å‰æ—¶é—´ä¸ºå¥‡æ•°ï¼Œå¯ä»¥æ‰§è¡Œä»»åŠ¡')
  } else {
    throw new Error('å½“å‰æ—¶é—´ä¸ºå¶æ•°ï¼Œæ— æ³•çŸ¥æ™“ä»»åŠ¡')
  }
}

// æ•è·å¼‚å¸¸é”™è¯¯
try {
  sometimes()
} catch (error) {
  alert(error.message)
}
```
##### é”™è¯¯å¯¹è±¡
é”™è¯¯ä¸€èˆ¬æœ‰ä¸¤ä¸ªå±æ€§ï¼š
- 1ã€`message`å±æ€§ï¼šé”™è¯¯ç›¸å…³ä¿¡æ¯
- 2ã€`stack`å±æ€§ï¼šå‡½æ•°è°ƒç”¨æ ˆè®°å½•ä¿¡æ¯
#### Promiseç®€ä»‹
è¯­æ³•ä¸Šï¼š`Promise`æ˜¯ä¸€ä¸ª**æ„é€ å‡½æ•°**  
åŠŸèƒ½ä¸Šï¼š`Promise`å¯¹è±¡ç”¨æ¥å°è£…ä¸€ä¸ª**å¼‚æ­¥æ“ä½œå¹¶è·å–å…¶æˆåŠŸ/å¤±è´¥çš„ç»“æœå€¼**  
  
Promiseæ˜¯JSä¸­è¿›è¡Œ**å¼‚æ­¥ç¼–ç¨‹**çš„æ–°è§£å†³æ–¹æ¡ˆï¼š

> æ—§è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å›è°ƒå‡½æ•°

#### Promiseçš„çŠ¶æ€æ”¹å˜
å®ä¾‹å¯¹è±¡ä¸­çš„ä¸€ä¸ªå±æ€§ï¼š `PromiseState`
- `pending`: æœªå†³å®šçš„
- 1ã€`pending`å˜ä¸º `resolved`ã€æˆåŠŸ(`fullfilled`)
- 2ã€`pending`å˜ä¸º `rejected`ã€å¤±è´¥

åªæœ‰è¿™ä¸¤ç§çŠ¶æ€ï¼Œä¸”ä¸€ä¸ª`promise` å¯¹è±¡åªèƒ½æ”¹å˜ä¸€æ¬¡ï¼ŒæˆåŠŸçš„ç»“æœæ•°æ®ä¸€èˆ¬ç§°ä¸º `value`ï¼Œå¤±è´¥çš„ç»“æœæ•°æ®ä¸€èˆ¬ç§°ä¸º `reason`  
#### Promiseå¯¹è±¡çš„å€¼
**å®ä¾‹å¯¹è±¡**çš„å¦ä¸€ä¸ªå±æ€§ï¼š`PromiseResult`  
ä¿å­˜ç€å¯¹è±¡ï¼šæˆåŠŸ/å¤±è´¥çš„ç»“æœ  
- `resolve`ï¼šæˆåŠŸ
- `reject`ï¼šå¤±è´¥

#### Promiseçš„åŸºæœ¬ä½¿ç”¨
##### ä½¿ç”¨Promiseå†™ä¸€ä¸ªæŠ½å¥–æ´»åŠ¨
```html
<div class="container">
  <div class="row">
    <h2>æŠ½å¥–æ´»åŠ¨Promiseç‰ˆ</h2>
    <hr>
    <button type="button" class="btn btn-outline-primary">ç‚¹å‡»æŠ½å¥–</button>
  </div>
</div>
<script>
  // ç”Ÿäº§éšæœºæ•°
  function rand(m, n) {
    return Math.ceil(Math.random() * (n - m + 1) + m - 1)
  }

  const btn = document.querySelector('button')

  btn.addEventListener('click', function () {
    // resolve è§£å†³  å‡½æ•°ç±»å‹çš„æ•°æ®
    // reject  æ‹’ç»  å‡½æ•°ç±»å‹çš„æ•°æ®
    const p = new Promise((resolve, reject) => {
      setTimeout(() => {
        // 30%
        let n = rand(1, 100)
        if (n <= 30) {
          resolve(n);  // å°† Promise å¯¹è±¡çš„çŠ¶æ€è®¾ç½®ä¸º æˆåŠŸ
        } else {
          reject(n);   // å°† Promise å¯¹è±¡çš„çŠ¶æ€è®¾ç½®ä¸º å¤±è´¥
        }
      }, 1000)
    })

    // è°ƒç”¨ then æ–¹æ³•
    p.then((value) => {
      alert('æ­å–œä½ ğŸ‰ä¸­å¥–äº†ï¼Œä¸­å¥–å·ç æ˜¯' + value)
    }, (reason) => {
      alert('å†æ¥å†å‰ä½ çš„å·ç æ˜¯' + reason)
    })
  })
</script>
```
##### ä½¿ç”¨Promiseè·å–AJAXè¯·æ±‚
```html
<div class="container">
  <div class="row">
    <h2>è·å–ç¬‘è¯Promiseç‰ˆ</h2>
    <hr>
    <button type="button" class="btn btn-outline-primary">ç‚¹å‡»è·å–ç¬‘è¯</button>
  </div>
</div>

<script>
  const btn = document.querySelector('button')

  btn.addEventListener('click', function () {
    const p = new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest()

      xhr.open('GET', 'https://api.apiopen.top/getJoke')
      xhr.send()

      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
          // æ³¨æ„readState å’Œstatusè¦åˆ†å¼€å†™
          if (xhr.status == 200) {
            // console.log('è¯·æ±‚æˆåŠŸ')
            resolve(xhr.response)
          } else {
            // console.log('è¯·æ±‚å¤±è´¥')
            reject(xhr.status)
          }
        }
      }
    })
    
    p.then(value => {
      console.log('è¯·æ±‚æˆåŠŸ' + value)
    }, reason => {
      console.log('è¯·æ±‚å¤±è´¥' + reason)
    })
  })
</script>
```
> [ä½¿ç”¨Promiseå°è£…fsè¯»å–æ–‡ä»¶æ“ä½œ](../demo/Promise/ä½¿ç”¨Promiseå°è£…fsè¯»å–æ–‡ä»¶æ“ä½œ.js)

##### ä½¿ç”¨Promiseè¯»å–æ–‡ä»¶
```js
const fs = require('fs')

let p = new Promise((resolve, rejects) => {
  fs.readFile('./text.txt', 'utf8', (err, data) => {
    // å¦‚æœå‡ºé”™ï¼Œè°ƒç”¨rejectså‡½æ•°å¹¶ä¼ é€’é”™è¯¯
    if (err) rejects(err);
    // å¦‚æœæˆåŠŸï¼Œè°ƒç”¨resolveå‡½æ•°å¹¶ä¼ é€’æ•°æ®
    resolve(data);
  })
})

// è°ƒç”¨thenæ–¹æ³•
p.then(value => {
  // æ‰“å°ä¼ é€’çš„æ•°æ®
  console.log(value)
}, reason => {
  // æ‰“å°
  console.log(reason)
})
```
##### util.promisifyæ–¹æ³•
`util.promisify` æ–¹æ³•ï¼š è¿”å›ä¸€ä¸ª`Promise` çš„ç‰ˆæœ¬
```js
/**
 * util.promisify æ–¹æ³•ï¼š è¿”å›ä¸€ä¸ªPromiseçš„ç‰ˆæœ¬
 */
//å¼•å…¥ util æ¨¡å—
const util = require('util');
//å¼•å…¥ fs æ¨¡å—
const fs = require('fs');
//è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°
let mineReadFile = util.promisify(fs.readFile);

mineReadFile('./text.txt', 'utf8').then(value => {
  console.log(value);
});
```


#### Promise Api
##### Promiseæ„é€ å‡½æ•°
```
1. Promise æ„é€ å‡½æ•°: Promise (excutor) {}
    excutorå‡½æ•°:åŒæ­¥æ‰§è¡Œ (resolve,reject)=>{}
    resolve å‡½æ•°: å†…éƒ¨å®šä¹‰æˆåŠŸæ—¶æˆ‘ä»¬è°ƒç”¨çš„å‡½æ•° value => {}
    reject å‡½æ•°: å†…éƒ¨å®šä¹‰å¤±è´¥æ—¶æˆ‘ä»¬è°ƒç”¨çš„å‡½æ•° reason => {}
è¯´æ˜: excutor ä¼šåœ¨ Promise å†…éƒ¨ç«‹å³åŒæ­¥å›è°ƒ,å¼‚æ­¥æ“ä½œåœ¨æ‰§è¡Œå™¨ä¸­æ‰§è¡Œ  
```
##### Promise.prototype.thenæ–¹æ³•
```
2. Promise.prototype.then æ–¹æ³•: (onResolved, onRejected) => {} 
    onResolvedå‡½æ•°:æˆåŠŸçš„å›è°ƒå‡½æ•° (value)=>{}
    onRejected å‡½æ•°: å¤±è´¥çš„å›è°ƒå‡½æ•° (reason) => {}
    è¯´æ˜: æŒ‡å®šç”¨äºå¾—åˆ°æˆåŠŸ value çš„æˆåŠŸå›è°ƒå’Œç”¨äºå¾—åˆ°å¤±è´¥ reason çš„å¤±è´¥å›è°ƒè¿”å›ä¸€ä¸ªæ–°çš„ promise å¯¹è±¡
```
##### Promise.prototype.catch æ–¹æ³•
```
3. Promise.prototype.catch æ–¹æ³•: (onRejected) => {}
    onRejected å‡½æ•°: å¤±è´¥çš„å›è°ƒå‡½æ•° (reason) => {}
    è¯´æ˜: then()çš„è¯­æ³•ç³–, ç›¸å½“äº: then(undefined, onRejected)
```
```js
let p = new Promsie((resolve, reject) => {
  // ä¿®æ”¹promise çš„çŠ¶æ€
  reject('error')
})

// æ‰§è¡Œ catch æ–¹æ³•
p.catch(reason => {
  console.log(reason)
})
```
##### Promise.resolve æ–¹æ³•
```
4. Promise.resolve æ–¹æ³•: (value) => {}
    value: æˆåŠŸçš„æ•°æ®æˆ– promise å¯¹è±¡
    è¯´æ˜: è¿”å›ä¸€ä¸ªæˆåŠŸ/å¤±è´¥çš„ promise å¯¹è±¡
```
```js
let p1 = Promise.resolve(52)
// å¦‚æœä¼ å…¥çš„å‚æ•°ä¸º éPromiseå¯¹è±¡ï¼Œåˆ™è¿”å›çš„ç»“æœæ˜¯æˆåŠŸçš„Promiseå¯¹è±¡
// å¦‚æœä¼ å…¥çš„å‚æ•°ä¸º Promiseå¯¹è±¡ï¼Œåˆ™å‚æ•°çš„ç»“æœå†³å®šäº† resolveçš„ç»“æœ
let p2 = Promise.resolve(new Promise((resolve, reject) => {
  reject('Error')
}))
p2.catch(reason => {
  console.log(reason)
})
```
##### Promise.reject æ–¹æ³•
```
5. Promise.reject æ–¹æ³•: (reason) => {}
    reason: å¤±è´¥çš„åŸå› 
    è¯´æ˜: è¿”å›ä¸€ä¸ªå¤±è´¥çš„ promise å¯¹è±¡
```
```js
/* æ— è®ºä¼ å…¥çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œæœ€åéƒ½è¿”å›ä¸€ä¸ªå¤±è´¥çš„Promise å¯¹è±¡ */
// let p = Promise.reject(2323)
// let p = Promise.reject('12qwer')
let p3 = Promise.reject(new Promise((resolve, reject) => {
  resolve('OK')
}))

console.log(p3)
```
##### Promise.all æ–¹æ³•
```
6. Promise.all æ–¹æ³•: (promises) => {}
    promises: åŒ…å« n ä¸ª promise çš„æ•°ç»„
    è¯´æ˜: è¿”å›ä¸€ä¸ªæ–°çš„ promise, åªæœ‰æ‰€æœ‰çš„ promise éƒ½æˆåŠŸæ‰æˆåŠŸ, åªè¦æœ‰ä¸€ä¸ªå¤±è´¥äº†å°±ç›´æ¥å¤±è´¥
```
```js
let p1 = new Promise((resolve, reject) => {
    resolve('OK');
})
// let p2 = Promise.resolve('Success');
let p2 = Promise.reject('Error');
let p3 = Promise.resolve('Oh Yeah');

const result = Promise.all([p1, p2, p3]);

console.log(result);        // Error
```
##### Promise.race æ–¹æ³•
```
7. Promise.race æ–¹æ³•: (promises) => {}
    promises: åŒ…å« n ä¸ª promise çš„æ•°ç»„
    è¯´æ˜: è¿”å›ä¸€ä¸ªæ–°çš„ promise, ç¬¬ä¸€ä¸ªå®Œæˆçš„ promise çš„ç»“æœçŠ¶æ€å°±æ˜¯æœ€ç»ˆçš„ç»“æœçŠ¶æ€
```
```js
let p1 = new Promise((resolve, reject) => {
    resolve('OK');
})
// let p2 = Promise.resolve('Success');
let p2 = Promise.reject('Error');
let p3 = Promise.resolve('Oh Yeah');

const result = Promise.all([p1, p2, p3]);

console.log(result);        // resolve(fulfille)
```
```js
/* å› ä¸ºp1é‡Œé¢æ˜¯å›è°ƒå‡½æ•°ï¼Œè¢«æ”¾å…¥äº†å›è°ƒé˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥ç”±ç¬¬äºŒä¸ªå†³å®š */
let p1 = new Promise((resolve, reject) => {
    setTimeout(() => {
        resolve('OK');
    }, 1000);
})
let p2 = Promise.reject('Error');
let p3 = Promise.resolve('Oh Yeah');

const result = Promise.race([p1, p2, p3]);

console.log(result);        // Error
```
#### Promiseçš„å…³é”®é—®é¢˜ 
##### å¦‚ä½•ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€
```js
let p = new Promise((resolve, reject) => {
  // 1ã€resolveå‡½æ•°
  // resolve(value)    // pending => fulfilled(resolved)
  // 2ã€rejectå‡½æ•°
  // reject(reason)  // pending => rejected
  // 3ã€æŠ›å‡ºé”™è¯¯
  throw 'å‡ºé—®é¢˜äº†'     // pending => rejected
})
```
##### èƒ½å¦æ‰§è¡Œå¤šä¸ªå›è°ƒ
å½“Promiseæ”¹å˜ä¸ºå¯¹åº”çŠ¶æ€æ—¶éƒ½ä¼šè°ƒç”¨
```js
/* å½“resolve()å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¸‹é¢çš„.then éƒ½ä¼šæ‰§è¡Œ */
/* å½“resolve()å‡½æ•°ä¸è¢«è°ƒç”¨æ—¶ï¼Œä¸‹é¢çš„.then éƒ½ä¸è¢«æ‰§è¡Œ */
let p = new Promise((resolve, reject) => {
  resolve('OK')
})

p.then(value => {
  console.log(value)
})

p.then(value => {
  alert(value)
})
```
> æ³¨æ„ï¼šå½“`reject()`,ä¹‹åçš„`.then()`ä¹Ÿä¼šæ‰§è¡Œ

##### æ”¹å˜ promise çŠ¶æ€å’ŒæŒ‡å®šå›è°ƒå‡½æ•°è°å…ˆè°å
1ã€éƒ½æœ‰å¯èƒ½, æ­£å¸¸æƒ…å†µä¸‹æ˜¯å…ˆæŒ‡å®šå›è°ƒå†æ”¹å˜çŠ¶æ€, ä½†ä¹Ÿå¯ä»¥å…ˆæ”¹çŠ¶æ€å†æŒ‡å®šå›è°ƒ
2ã€å¦‚ä½•å…ˆæ”¹çŠ¶æ€å†æŒ‡å®šå›è°ƒ?
- 1 åœ¨æ‰§è¡Œå™¨ä¸­ç›´æ¥è°ƒç”¨`resolve()/reject()`
- 2 å»¶è¿Ÿæ›´é•¿æ—¶é—´æ‰è°ƒç”¨`then()`
3ã€ä»€ä¹ˆæ—¶å€™æ‰èƒ½å¾—åˆ°æ•°æ®?
- 1 å¦‚æœå…ˆæŒ‡å®šçš„å›è°ƒ, é‚£å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶, å›è°ƒå‡½æ•°å°±ä¼šè°ƒç”¨, å¾—åˆ°æ•°æ® 
- 2 å¦‚æœå…ˆæ”¹å˜çš„çŠ¶æ€, é‚£å½“æŒ‡å®šå›è°ƒæ—¶, å›è°ƒå‡½æ•°å°±ä¼šè°ƒç”¨, å¾—åˆ°æ•°æ®

##### promise.then()è¿”å›çš„æ–° promise çš„ç»“æœçŠ¶æ€ç”±ä»€ä¹ˆå†³å®š
(1) ç®€å•è¡¨è¾¾:`ç”±then()`æŒ‡å®šçš„å›è°ƒå‡½æ•°æ‰§è¡Œçš„ç»“æœå†³å®š  
(2) è¯¦ç»†è¡¨è¾¾:
- 1 å¦‚æœæŠ›å‡ºå¼‚å¸¸, æ–°`promise` å˜ä¸º `rejected`, `reason` ä¸ºæŠ›å‡ºçš„å¼‚å¸¸
- 2 å¦‚æœè¿”å›çš„æ˜¯é`promise` çš„ä»»æ„å€¼, æ–°`promise` å˜ä¸º`resolved`, `value` ä¸ºè¿”å›çš„
- 3 å¦‚æœè¿”å›çš„æ˜¯å¦ä¸€ä¸ªæ–°`promise`, æ­¤`promise`çš„ç»“æœå°±ä¼šæˆä¸ºæ–°`promise`çš„ç»“æœ

```js
let p = new Promise((resolve, reject) => {
    resolve('ok');
});
//æ‰§è¡Œ then æ–¹æ³•
let result = p.then(value => {
    // console.log(value);
    //1. æŠ›å‡ºé”™è¯¯
    // throw 'å‡ºäº†é—®é¢˜';
    //2. è¿”å›ç»“æœæ˜¯é Promise ç±»å‹çš„å¯¹è±¡
    // return 521;
    //3. è¿”å›ç»“æœæ˜¯ Promise å¯¹è±¡
    // return new Promise((resolve, reject) => {
    //     // resolve('success');
    //     reject('error');
    // });
}, reason => {
    console.warn(reason);
});

console.log(result); // 1ã€Error 2ã€resolve 3ã€Error
```
##### promise å¦‚ä½•ä¸²è¿å¤šä¸ªæ“ä½œä»»åŠ¡?
(1) `promise` çš„ `then()`è¿”å›ä¸€ä¸ªæ–°çš„ `promise`, å¯ä»¥å¼€å¯ `then()`çš„é“¾å¼è°ƒç”¨  
(2) é€šè¿‡`then`çš„**é“¾å¼è°ƒç”¨**ä¸²è¿å¤šä¸ªåŒæ­¥/å¼‚æ­¥ä»»åŠ¡  
```js
let p = new Promise((resolve, reject) => {
    setTimeout(() => {
        resolve('OK');
    }, 1000);
});

p.then(value => {
    return new Promise((resolve, reject) => {
        resolve("success");
    });
}).then(value => {
    console.log(value); // success
}).then(value => {
    console.log(value); // undefined
})
```
##### promise å¼‚å¸¸ä¼ é€?
(1) å½“ä½¿ç”¨`promise` çš„`then` é“¾å¼è°ƒç”¨æ—¶ï¼Œå¯ä»¥åœ¨æœ€åæŒ‡å®šå¤±è´¥çš„å›è°ƒ   
(2) å‰é¢**ä»»ä½•æ“ä½œå‡ºäº†å¼‚å¸¸, éƒ½ä¼šä¼ åˆ°æœ€åå¤±è´¥çš„å›è°ƒä¸­å¤„ç†**
```js
let p = new Promise((resolve, reject) => {
    setTimeout(() => {
        resolve('OK');
        // reject('Err');
    }, 1000);
});

p.then(value => {
    // console.log(111);
    throw 'å¤±è´¥å•¦!';
}).then(value => {
    console.log(222);
}).then(value => {
    console.log(333);
}).catch(reason => {
    console.log(reason);
});
```
##### ä¸­æ–­ promise é“¾?
(1) å½“ä½¿ç”¨`promise` çš„`then` é“¾å¼è°ƒç”¨æ—¶ï¼Œåœ¨ä¸­é—´ä¸­æ–­ï¼Œä¸å†è°ƒç”¨åé¢çš„å›è°ƒå‡½æ•°   
(2) åŠæ³•ï¼šåœ¨å›è°ƒå‡½æ•°ä¸­è¿”å›ä¸€ä¸ª`pendding` çŠ¶æ€çš„`promise` å¯¹è±¡
```js
let p = new Promise((resolve, reject) => {
    setTimeout(() => {
        resolve('OK');
    }, 1000);
});

p.then(value => {
    console.log(111);
    //æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ–¹å¼ï¼Œè¿”å›ä¸€ä¸ªpendingçŠ¶æ€çš„Promise
    return new Promise(() => {});
}).then(value => {
    console.log(222);
}).then(value => {
    console.log(333);
}).catch(reason => {
    console.warn(reason);
});
```
### async/await
#### async å‡½æ•°
`async`å‡½æ•°çš„è¿”å›å€¼ä¸º`promise`å¯¹è±¡ï¼Œ`promise`å¯¹è±¡çš„ç»“æœç”±`async`å‡½æ•°æ‰§è¡Œçš„è¿”å›å€¼å†³å®š
```js
async function main(){
  // 1ã€å¦‚æœè¿”å›å€¼æ˜¯ä¸€ä¸ªéPromiseç±»å‹çš„æ•°æ®ï¼Œåˆ™è¿”å›æˆåŠŸçš„Promiseå¯¹è±¡ï¼Œreturnåé¢æ˜¯ä»€ä¹ˆï¼ŒæˆåŠŸçš„ç»“æœå€¼å°±æ˜¯ä»€ä¹ˆ
  // return 521

  // 2ã€å¦‚æœè¿”å›å€¼çš„æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œåˆ™è¿”å›çš„Promiseå¯¹è±¡å–å†³äºè¿”å›å€¼Promiseå¯¹è±¡çš„æ­£è¯¯
  return new Promise((resolve, reject) => {
    // resolve('OK')
    reject('Error')
  })

  // 3ã€æŠ›å‡ºå¼‚å¸¸
  throw "oh no"
}

let result = main()

console.log(result)  // Promiseå¯¹è±¡
```
#### await è¡¨è¾¾å¼
- 1ã€`await` å³ä¾§çš„è¡¨è¾¾å¼ä¸€èˆ¬ä¸º `promise` å¯¹è±¡, ä½†ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒçš„å€¼
- 2ã€å¦‚æœè¡¨è¾¾å¼æ˜¯ `promise` å¯¹è±¡, `await` è¿”å›çš„æ˜¯ `promise` æˆåŠŸçš„å€¼
- 3ã€å¦‚æœè¡¨è¾¾å¼æ˜¯å…¶å®ƒå€¼, ç›´æ¥å°†æ­¤å€¼ä½œä¸º `await` çš„è¿”å›å€¼

```js
async function main(){
  let p = new Promise((resolve, reject) => {
    // resolve('OK')
    reject('Error')
  })
  // 1ã€å³ä¾§ä¸ºPromiseçš„æƒ…å†µ
  let res = await p

  // 2ã€å³ä¾§ä¸ºå…¶ä»–ç±»å‹çš„æ•°æ®
  // let res2 = await 20;

  // 3ã€å¦‚æœPromiseæ˜¯å¤±è´¥çš„çŠ¶æ€
  try {
    let res3 = await p
  }catch(e){
    console.log(e)         // Error
  }

  // console.log(res)      // OK
  // console.log(res2)     // 20
}

main()
```

> 1ã€`await` å¿…é¡»å†™åœ¨`async` å‡½æ•°ä¸­, ä½†`async` å‡½æ•°ä¸­å¯ä»¥æ²¡æœ‰ `await`  
> 2ã€å¦‚æœ`await` çš„`promise` å¤±è´¥äº†, å°±ä¼šæŠ›å‡ºå¼‚å¸¸, éœ€è¦é€šè¿‡ `try...catch` æ•è·å¤„ç†  

#### async ä¸ awaitç»“åˆä½¿ç”¨
##### è¯»å–æ–‡ä»¶
```js
const fs = require('fs');
const util = require('util');
const mineReadFile = util.promisify(fs.readFile);

//å›è°ƒå‡½æ•°çš„æ–¹å¼
// fs.readFile('./resource/1.html', (err, data1) => {
//     if(err) throw err;
//     fs.readFile('./resource/2.html', (err, data2) => {
//         if(err) throw err;
//         fs.readFile('./resource/3.html', (err, data3) => {
//             if(err) throw err;
//             console.log(data1 + data2 + data3);
//         });
//     });
// });

//async ä¸ await
async function main(){
    try{
        //è¯»å–ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹
        let data1 = await mineReadFile('./resource/1x.html');
        let data2 = await mineReadFile('./resource/2.html');
        let data3 = await mineReadFile('./resource/3.html');
        console.log(data1 + data2 + data3);
    }catch(e){
        console.log(e.code);
    }
}
main();
```
##### å‘é€AJAXè¯·æ±‚
```js
function sendAJAX(url){
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.responseType = 'json';
    xhr.open("GET", url);
    xhr.send();
    //å¤„ç†ç»“æœ
    xhr.onreadystatechange = function(){
      if(xhr.readyState === 4){
        //åˆ¤æ–­æˆåŠŸ
        if(xhr.status >= 200 && xhr.status < 300){
          //æˆåŠŸçš„ç»“æœ
          resolve(xhr.response);
        }else{
          reject(xhr.status);
        }
      }
    }
  });
}

//æ®µå­æ¥å£åœ°å€ https://api.apiopen.top/getJoke
let btn = document.querySelector('#btn');

btn.addEventListener('click',async function(){
  //è·å–æ®µå­ä¿¡æ¯
  let duanzi = await sendAJAX('https://api.apiopen.top/getJoke');
  console.log(duanzi);
});
```
### EventLoop
### å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡
